<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System zarządzania magazynem</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .warehouse {
            position: relative;
            width: 100vw;
            height: 70vh;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
        }
        .shelf {
            width: 150px;
            height: 90px;
            background-color: #6c757d;
            color: white;
            text-align: center;
            cursor: move;
            position: absolute;
            padding: 15px;
            box-sizing: border-box;
            user-select: none;
            touch-action: none;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .shelf.highlighted {
            background-color: #ffc107;
            box-shadow: 0 0 20px #ffc107;
            transform: scale(1.05);
            z-index: 100;
        }
        .controls {
            width: 30vw;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        input[type="url"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-size: 14px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #218838;
        }
        .items-container {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
        }
        .floor-items {
            margin-bottom: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .floor-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #495057;
            font-size: 15px;
        }
        .item-entry {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        .item-entry.highlighted-item {
            background-color: #fff3cd;
            font-weight: bold;
        }
        .hidden-item {
            display: none;
        }
        .hidden-floor {
            display: none;
        }
        .hidden-shelf {
            display: none;
        }
        .popup {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            border-radius: 6px;
            max-width: 350px;
            max-height: 250px;
            overflow-y: auto;
            font-size: 14px;
        }
        .import-export {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .reset-btn {
            background-color: #dc3545;
            margin-top: 15px;
        }
        .reset-btn:hover {
            background-color: #c82333;
        }
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .confirmation-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            max-width: 450px;
            text-align: center;
        }
        .confirmation-buttons {
            margin-top: 25px;
        }
        .confirmation-buttons button {
            margin: 0 12px;
            padding: 10px 20px;
        }
        .shelf-button {
            margin-top: 8px;
            padding: 6px 10px;
            font-size: 13px;
        }
        .allegro-link {
            color: #007bff;
            text-decoration: none;
            font-size: 12px;
            display: block;
            margin-top: 5px;
            word-break: break-all;
        }
        .allegro-link:hover {
            text-decoration: underline;
        }
        .search-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            top: 10px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .search-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }
        #search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        #search:focus {
            outline: none;
            border-color: #6c757d;
            box-shadow: 0 0 0 2px rgba(108, 117, 125, 0.25);
        }
        #search-results {
            font-size: 13px;
            color: #6c757d;
            padding: 5px;
            max-height: 150px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .allegro-form {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .item-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .item-actions button {
            padding: 3px 6px;
            font-size: 12px;
        }
        .edit-btn {
            background-color: #17a2b8;
        }
        .delete-btn {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <h1>System zarządzania magazynem</h1>
    <div class="container">
        <div class="search-container">
            <div class="input-group">
                <h3>Wyszukiwarka</h3>
                <input type="text" id="search" placeholder="Wpisz nazwę przedmiotu..." onkeyup="searchItem()">
            </div>
            <div id="search-results"></div>
        </div>
    </div>
    
    <h3>Magazyn</h3>
    <div class="container">
        <div class="warehouse" id="warehouse">
            <div id="search-results"></div>
        </div>
        
        <div class="controls">
            <div class="input-group">
                <h3>Dodaj nowy regał</h3>
                <label for="shelf-name">Nazwa regału:</label>
                <input type="text" id="shelf-name" placeholder="Wprowadź nazwę regału" required>
                
                <label for="shelf-levels">Liczba pięter:</label>
                <input type="number" id="shelf-levels" placeholder="Wprowadź liczbę pięter" min="1" required>
                
                <button onclick="addShelf()">Dodaj regał</button>
            </div>
            
            <div class="allegro-form">
                <h3>Dodaj przedmiot z Allegro</h3>
                <label for="allegro-url">URL aukcji Allegro:</label>
                <input type="url" id="allegro-url" placeholder="Wklej link do aukcji Allegro">
                <button onclick="addItemFromAllegro()">Pobierz dane</button>
                <div id="allegro-preview" style="margin-top: 10px; display: none;">
                    <strong>Tytuł aukcji:</strong> <span id="allegro-title"></span><br>
                    <strong>Dostępna ilość:</strong> <span id="allegro-quantity"></span>
                </div>
            </div>
            
            <div class="import-export">
                <h3>Import/Export danych</h3>
                <input type="file" id="import-file" accept=".csv" style="margin-bottom: 12px;">
                <button onclick="importData()" style="margin-right: 12px;">Importuj CSV</button>
                <button onclick="exportData()" style="margin-right: 12px;">Eksportuj do CSV</button>
                <button onclick="showResetConfirmation()" class="reset-btn">Resetuj wszystko</button>
            </div>
        </div>
    </div>
    
    <h3>Lista przedmiotów i stan magazynu</h3>
    <div class="items-container" id="items-container">
        <div id="items-list"></div>
    </div>
    
    <div class="popup" id="popup"></div>

<script>
    let shelves = [];
    let searchQuery = '';
    let draggedShelf = null;
    let offsetX, offsetY;
    let updateIntervals = {};
    
    // Ładowanie danych z localStorage przy starcie
    function loadData() {
        const savedData = localStorage.getItem('warehouseData');
        if (savedData) {
            shelves = JSON.parse(savedData);
            renderShelves();
            updateItemsList();
            // Przywróć interwały aktualizacji dla przedmiotów z Allegro
            restoreAllegroIntervals();
        }
    }
    
    // Zapisywanie danych do localStorage
    function saveData() {
        localStorage.setItem('warehouseData', JSON.stringify(shelves));
    }
    
    // Funkcja dodająca nowy regał
    function addShelf() {
        const nameInput = document.getElementById('shelf-name');
        const levelsInput = document.getElementById('shelf-levels');
        const name = nameInput.value.trim();
        const levels = parseInt(levelsInput.value);
        
        // Walidacja danych
        if (!name) {
            alert('Proszę wprowadzić nazwę regału!');
            nameInput.focus();
            return;
        }
        
        if (isNaN(levels)) {
            alert('Proszę wprowadzić poprawną liczbę pięter!');
            levelsInput.focus();
            return;
        }
        
        if (levels <= 0) {
            alert('Liczba pięter musi być większa niż 0!');
            levelsInput.focus();
            return;
        }

        const warehouse = document.getElementById('warehouse');
        const warehouseRect = warehouse.getBoundingClientRect();
        
        // Obliczanie pozycji w granicach magazynu
        const maxX = warehouseRect.width - 160;
        const maxY = warehouseRect.height - 100;
        
        const shelf = {
            id: `shelf-${Date.now()}`,
            name,
            levels,
            items: {},
            x: Math.random() * maxX,
            y: Math.random() * maxY
        };

        // Inicjalizacja pustych pięter
        for (let i = 1; i <= levels; i++) {
            shelf.items[`P${i}`] = {};
        }

        shelves.push(shelf);
        renderShelves();
        updateItemsList();
        saveData();
        
        // Wyczyszczenie pól formularza
        nameInput.value = '';
        levelsInput.value = '';
        nameInput.focus();
    }

    // Renderowanie regałów w magazynie
    function renderShelves() {
        const warehouse = document.getElementById('warehouse');
        warehouse.innerHTML = '';

        shelves.forEach((shelf) => {
            const shelfElement = document.createElement('div');
            shelfElement.className = 'shelf';
            shelfElement.id = shelf.id;
            shelfElement.style.left = `${shelf.x}px`;
            shelfElement.style.top = `${shelf.y}px`;
            shelfElement.innerHTML = `
                <strong>${shelf.name}</strong>
                <div>${shelf.levels} pięt${shelf.levels === 1 ? 'ro' : 'er'}</div>
            `;

            // Dodanie zdarzeń przeciągania
            shelfElement.addEventListener('mousedown', startDrag);
            
            // Przycisk dodawania przedmiotu
            const addItemButton = document.createElement('button');
            addItemButton.className = 'shelf-button';
            addItemButton.innerText = 'Dodaj przedmiot';
            addItemButton.onclick = (e) => {
                e.stopPropagation();
                addItem(shelf);
            };
            shelfElement.appendChild(addItemButton);

            // Zdarzenia najechania myszą
            shelfElement.addEventListener('mouseenter', () => showShelfItems(shelf));
            shelfElement.addEventListener('mouseleave', () => {
                const popup = document.getElementById('popup');
                popup.style.display = 'none';
            });

            warehouse.appendChild(shelfElement);
        });
    }
	
	

    // Wyświetlanie przedmiotów w regale po najechaniu
    function showShelfItems(shelf) {
        const popup = document.getElementById('popup');
        const shelfElement = document.getElementById(shelf.id);
        const rect = shelfElement.getBoundingClientRect();
        
        popup.style.left = `${rect.right + 10}px`;
        popup.style.top = `${rect.top}px`;
        
        let itemsHtml = `<strong>${shelf.name}</strong><br>`;
        let hasItems = false;
        
        for (let floor in shelf.items) {
            const items = shelf.items[floor];
            if (Object.keys(items).length > 0) {
                hasItems = true;
                itemsHtml += `<br><b>${floor}:</b><br>`;
                for (let item in items) {
                    const itemData = items[item];
                    const quantity = typeof itemData === 'object' ? itemData.quantity : itemData;
                    const url = typeof itemData === 'object' ? itemData.url : null;
                    
                    itemsHtml += `${item} (${quantity})`;
                    if (url) {
                        itemsHtml += ` <a href="${url}" target="_blank" style="font-size:11px;color:#007bff;">[link]</a>`;
                    }
                    itemsHtml += '<br>';
                }
            }
        }
        
        if (!hasItems) {
            itemsHtml += '<br>Brak przedmiotów';
        }
        
        popup.innerHTML = itemsHtml;
        popup.style.display = 'block';
    }





    // Dodawanie przedmiotu do regału
    function addItem(shelf, itemName = null, quantity = null, url = null, fromAllegro = false) {
        if (!itemName) {
            itemName = prompt('Podaj nazwę przedmiotu:');
            if (!itemName) return;
        }
        
        if (!quantity) {
            quantity = parseInt(prompt('Podaj ilość:'));
            if (isNaN(quantity)) {
                alert('Podaj poprawną ilość!');
                return;
            }
        }
        
        // Tworzenie okna wyboru pięter
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '2000';
        
        const modalContent = document.createElement('div');
        modalContent.style.backgroundColor = 'white';
        modalContent.style.padding = '25px';
        modalContent.style.borderRadius = '10px';
        modalContent.style.width = '350px';
        
        modalContent.innerHTML = `
            <h3 style="margin-top: 0;">Dodaj "${itemName}" do:</h3>
            <p>Wybierz piętra w regale ${shelf.name}:</p>
            <div class="floor-checkboxes" id="floor-checkboxes"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="cancel-btn" style="background-color: #dc3545; margin-right: 15px;">Anuluj</button>
                <button id="confirm-btn">Dodaj</button>
            </div>
        `;
        
        const checkboxesDiv = modalContent.querySelector('#floor-checkboxes');
        for (let i = 1; i <= shelf.levels; i++) {
            const floorId = `P${i}`;
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `floor-${floorId}`;
            checkbox.value = floorId;
            
            const label = document.createElement('label');
            label.htmlFor = `floor-${floorId}`;
            label.textContent = ` Piętro ${i}`;
            
            checkboxItem.appendChild(checkbox);
            checkboxItem.appendChild(label);
            checkboxesDiv.appendChild(checkboxItem);
        }
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Obsługa przycisków
        modalContent.querySelector('#cancel-btn').onclick = function() {
            document.body.removeChild(modal);
        };
        
        modalContent.querySelector('#confirm-btn').onclick = function() {
            const checkboxes = checkboxesDiv.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Wybierz co najmniej jedno piętro!');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const floor = checkbox.value;
                const itemData = url ? { quantity: quantity, url: url } : quantity;
                
                if (shelf.items[floor][itemName]) {
                    if (typeof shelf.items[floor][itemName] === 'object') {
                        shelf.items[floor][itemName].quantity += quantity;
                    } else {
                        shelf.items[floor][itemName] += quantity;
                    }
                } else {
                    shelf.items[floor][itemName] = itemData;
                }
            });
            
            // Jeśli to przedmiot z Allegro, uruchom cykliczną aktualizację
            if (fromAllegro && url) {
                startAllegroItemUpdate(shelf.id, itemName, url);
            }
            
            updateItemsList();
            saveData();
            document.body.removeChild(modal);
        };
    }

    // Aktualizacja listy przedmiotów
    function updateItemsList() {
        const container = document.getElementById('items-container');
        container.innerHTML = '';
        
        if (shelves.length === 0) {
            container.innerHTML = '<p>Brak regałów w magazynie</p>';
            return;
        }
        
        shelves.forEach(shelf => {
            const shelfTitle = document.createElement('h4');
            shelfTitle.textContent = `Regał: ${shelf.name}`;
            container.appendChild(shelfTitle);
            
            for (let floor in shelf.items) {
                const floorDiv = document.createElement('div');
                floorDiv.className = 'floor-items';
                floorDiv.dataset.shelfName = shelf.name.toLowerCase();
                floorDiv.dataset.floorName = floor.toLowerCase();
                
                const floorTitle = document.createElement('div');
                floorTitle.className = 'floor-title';
                floorTitle.textContent = `${floor}:`;
                floorDiv.appendChild(floorTitle);
                
                const items = shelf.items[floor];
                if (Object.keys(items).length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.textContent = 'Brak przedmiotów';
                    floorDiv.appendChild(emptyMsg);
                } else {
                    for (let item in items) {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'item-entry';
                        itemDiv.dataset.itemName = item.toLowerCase();
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = item;
                        
                        const quantitySpan = document.createElement('span');
                        const quantity = typeof items[item] === 'object' ? items[item].quantity : items[item];
                        quantitySpan.textContent = quantity;
                        
                        itemDiv.appendChild(nameSpan);
                        itemDiv.appendChild(quantitySpan);
                        
                        // Dodaj link do Allegro jeśli istnieje
                        if (typeof items[item] === 'object' && items[item].url) {
                            const link = document.createElement('a');
                            link.href = items[item].url;
                            link.target = '_blank';
                            link.className = 'allegro-link';
                            link.textContent = 'Zobacz na Allegro';
                            itemDiv.appendChild(link);
                        }
                        
                        // Dodaj przyciski akcji
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'item-actions';
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.textContent = 'Edytuj';
                        editBtn.onclick = () => editItem(shelf, floor, item);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = 'Usuń';
                        deleteBtn.onclick = () => deleteItem(shelf, floor, item);
                        
                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(deleteBtn);
                        itemDiv.appendChild(actionsDiv);
                        
                        floorDiv.appendChild(itemDiv);
                    }
                }
                
                container.appendChild(floorDiv);
            }
        });
    }

    // Edycja przedmiotu
    function editItem(shelf, floor, itemName) {
        const itemData = shelf.items[floor][itemName];
        const currentQuantity = typeof itemData === 'object' ? itemData.quantity : itemData;
        
        const newName = prompt('Nowa nazwa przedmiotu:', itemName);
        if (newName === null) return;
        
        const newQuantity = parseInt(prompt('Nowa ilość:', currentQuantity));
        if (isNaN(newQuantity)) {
            alert('Podaj poprawną ilość!');
            return;
        }
        
        // Jeśli przedmiot zmienia nazwę, musimy go usunąć i dodać na nowo
        if (newName !== itemName) {
            delete shelf.items[floor][itemName];
            
            if (typeof itemData === 'object') {
                shelf.items[floor][newName] = {
                    quantity: newQuantity,
                    url: itemData.url
                };
            } else {
                shelf.items[floor][newName] = newQuantity;
            }
            
            // Jeśli to przedmiot z Allegro, zaktualizuj interwał
            if (typeof itemData === 'object' && itemData.url) {
                clearInterval(updateIntervals[`${shelf.id}-${itemName}`]);
                delete updateIntervals[`${shelf.id}-${itemName}`];
                startAllegroItemUpdate(shelf.id, newName, itemData.url);
            }
        } else {
            // Tylko aktualizacja ilości
            if (typeof itemData === 'object') {
                shelf.items[floor][itemName].quantity = newQuantity;
            } else {
                shelf.items[floor][itemName] = newQuantity;
            }
        }
        
        updateItemsList();
        saveData();
    }

    // Usuwanie przedmiotu
    function deleteItem(shelf, floor, itemName) {
        if (confirm(`Czy na pewno chcesz usunąć przedmiot "${itemName}" z ${floor} regału "${shelf.name}"?`)) {
            // Jeśli to przedmiot z Allegro, zatrzymaj interwał aktualizacji
            const itemData = shelf.items[floor][itemName];
            if (typeof itemData === 'object' && itemData.url) {
                clearInterval(updateIntervals[`${shelf.id}-${itemName}`]);
                delete updateIntervals[`${shelf.id}-${itemName}`];
            }
            
            delete shelf.items[floor][itemName];
            updateItemsList();
            saveData();
        }
    }

    // Funkcje przeciągania regałów
    function startDrag(e) {
        if (!e.target.classList.contains('shelf')) return;
        
        draggedShelf = shelves.find(s => s.id === e.target.id);
        if (!draggedShelf) return;
        
        const shelfElement = document.getElementById(draggedShelf.id);
        const rect = shelfElement.getBoundingClientRect();
        
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        
        shelfElement.style.zIndex = '100';
        shelfElement.style.cursor = 'grabbing';
        
        document.addEventListener('mousemove', dragShelf);
        document.addEventListener('mouseup', stopDrag);
    }

    function dragShelf(e) {
        if (!draggedShelf) return;
        
        const warehouse = document.getElementById('warehouse');
        const warehouseRect = warehouse.getBoundingClientRect();
        const shelfElement = document.getElementById(draggedShelf.id);
        
        let newX = e.clientX - warehouseRect.left - offsetX;
        let newY = e.clientY - warehouseRect.top - offsetY;
        
        // Sprawdzanie granic magazynu
        newX = Math.max(0, Math.min(newX, warehouseRect.width - shelfElement.offsetWidth));
        newY = Math.max(0, Math.min(newY, warehouseRect.height - shelfElement.offsetHeight));
        
        shelfElement.style.left = `${newX}px`;
        shelfElement.style.top = `${newY}px`;
    }

    function stopDrag() {
        if (!draggedShelf) return;
        
        const shelfElement = document.getElementById(draggedShelf.id);
        const rect = shelfElement.getBoundingClientRect();
        const warehouseRect = document.getElementById('warehouse').getBoundingClientRect();
        
        // Aktualizacja pozycji w modelu danych
        draggedShelf.x = rect.left - warehouseRect.left;
        draggedShelf.y = rect.top - warehouseRect.top;
        
        shelfElement.style.zIndex = '';
        shelfElement.style.cursor = 'move';
        
        document.removeEventListener('mousemove', dragShelf);
        document.removeEventListener('mouseup', stopDrag);
        draggedShelf = null;
        
        saveData();
    }

    function searchItem() {
        searchQuery = document.getElementById('search').value.toLowerCase().trim();
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = '';
        
        // Reset podświetleń wszystkich elementów
        document.querySelectorAll('.shelf').forEach(el => {
            el.classList.remove('highlighted');
        });
        
        document.querySelectorAll('.floor-items').forEach(el => {
            el.classList.remove('hidden-floor');
        });
        
        document.querySelectorAll('.item-entry').forEach(el => {
            el.classList.remove('highlighted-item');
        });
        
        // Jeśli puste wyszukiwanie - pokaż wszystko
        if (!searchQuery) {
            return;
        }
        
        let foundShelves = new Set();
        let foundItems = 0;
        
        // Szukanie przedmiotów
        shelves.forEach(shelf => {
            let shelfHasMatches = false;
            
            for (let floor in shelf.items) {
                let floorHasMatches = false;
                const items = shelf.items[floor];
                
                for (let item in items) {
                    if (item.toLowerCase().includes(searchQuery)) {
                        foundShelves.add(shelf.id);
                        foundItems++;
                        shelfHasMatches = true;
                        floorHasMatches = true;
                        
                        // Podświetlenie na liście
                        const itemEntries = document.querySelectorAll(
                            `.item-entry[data-item-name="${item.toLowerCase()}"]`
                        );
                        
                        itemEntries.forEach(el => {
                            if (el.textContent.toLowerCase().includes(searchQuery)) {
                                el.classList.add('highlighted-item');
                            }
                        });
                    }
                }
                
                // Ukryj piętra bez pasujących przedmiotów
                if (!floorHasMatches) {
                    const floorDivs = document.querySelectorAll(
                        `.floor-items[data-shelf-name="${shelf.name.toLowerCase()}"][data-floor-name="${floor.toLowerCase()}"]`
                    );
                    
                    floorDivs.forEach(el => {
                        el.classList.add('hidden-floor');
                    });
                }
            }
            
            // Podświetl regały z pasującymi przedmiotami
            if (shelfHasMatches) {
                const shelfEl = document.getElementById(shelf.id);
                if (shelfEl) {
                    shelfEl.classList.add('highlighted');
                }
            }
        });
        
        // Wyświetlenie wyników
        if (foundShelves.size > 0) {
            resultsDiv.innerHTML = `Znaleziono ${foundItems} przedmiotów na ${foundShelves.size} regałach`;
        } else {
            resultsDiv.innerHTML = 'Nie znaleziono przedmiotu';
        }
    }

    // Export danych do CSV z uwzględnieniem stanu
    function exportData() {
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Nagłówki kolumn
        csvContent += "Regał,Pietro,Przedmiot,Ilość,URL,X,Y\n";
        
        // Dane
        shelves.forEach(shelf => {
            for (let floor in shelf.items) {
                for (let item in shelf.items[floor]) {
                    const itemData = shelf.items[floor][item];
                    const quantity = typeof itemData === 'object' ? itemData.quantity : itemData;
                    const url = typeof itemData === 'object' ? itemData.url : '';
                    csvContent += `"${shelf.name}","${floor}","${item}",${quantity},"${url}",${shelf.x},${shelf.y}\n`;
                }
            }
        });
        
        // Tworzenie linku do pobrania
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "magazyn_" + new Date().toISOString().slice(0,10) + ".csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Import danych z CSV
    function importData() {
        const fileInput = document.getElementById('import-file');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Wybierz plik do importu!');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const lines = content.split('\n');
            
            // Tymczasowe struktury do przechowywania danych
            const newShelves = [];
            const shelfMap = {};
            
            // Pomijamy nagłówek (linia 0) i przetwarzamy dane
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const parts = lines[i].split(',');
                if (parts.length < 6) continue;
                
                // Czyszczenie cudzysłowów
                const shelfName = parts[0].replace(/"/g, '');
                const floor = parts[1].replace(/"/g, '');
                const item = parts[2].replace(/"/g, '');
                const quantity = parseInt(parts[3]);
                const url = parts[4] ? parts[4].replace(/"/g, '') : null;
                const x = parseFloat(parts[5]);
                const y = parseFloat(parts[6]);
                
                // Sprawdzamy czy regał już istnieje
                let shelf = shelfMap[shelfName];
                if (!shelf) {
                    // Szukamy liczby pięter dla tego regału
                    let maxFloor = 0;
                    for (let j = 1; j < lines.length; j++) {
                        if (lines[j].trim() === '') continue;
                        const p = lines[j].split(',');
                        const name = p[0].replace(/"/g, '');
                        if (name === shelfName) {
                            const fl = p[1].replace(/"/g, '');
                            const floorNum = parseInt(fl.substring(1));
                            if (floorNum > maxFloor) maxFloor = floorNum;
                        }
                    }
                    
                    // Tworzymy nowy regał
                    shelf = {
                        id: `shelf-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                        name: shelfName,
                        levels: maxFloor,
                        items: {},
                        x: x,
                        y: y
                    };
                    
                    // Inicjalizacja pięter
                    for (let j = 1; j <= maxFloor; j++) {
                        shelf.items[`P${j}`] = {};
                    }
                    
                    shelfMap[shelfName] = shelf;
                    newShelves.push(shelf);
                }
                
                // Dodajemy przedmiot do odpowiedniego piętra
                if (shelf.items[floor]) {
                    shelf.items[floor][item] = url ? { quantity: quantity, url: url } : quantity;
                }
            }
            
            shelves = newShelves;
            renderShelves();
            updateItemsList();
            saveData();
            
            // Uruchom interwały aktualizacji dla przedmiotów z Allegro
            restoreAllegroIntervals();
            
            alert(`Zaimportowano dane z ${newShelves.length} regałami`);
            fileInput.value = '';
        };
        
        reader.readAsText(file);
    }

    // Funkcja resetująca wszystkie dane
    function resetAllData() {
        // Zatrzymaj wszystkie interwały aktualizacji
        for (let key in updateIntervals) {
            clearInterval(updateIntervals[key]);
        }
        updateIntervals = {};
        
        shelves = [];
        renderShelves();
        updateItemsList();
        saveData();
        document.getElementById('search').value = '';
        document.getElementById('search-results').innerHTML = '';
    }

    // Pokazanie dialogu potwierdzenia resetu
    function showResetConfirmation() {
        const dialog = document.createElement('div');
        dialog.className = 'confirmation-dialog';
        dialog.innerHTML = `
            <div class="confirmation-content">
                <h3>Czy na pewno chcesz zresetować wszystkie dane?</h3>
                <p>Ta operacja usunie wszystkie regały i przedmioty. Nie można jej cofnąć.</p>
                <div class="confirmation-buttons">
                    <button onclick="confirmReset(true)">Tak, zresetuj</button>
                    <button onclick="confirmReset(false)">Anuluj</button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }

    // Potwierdzenie resetu
    function confirmReset(confirmed) {
        document.querySelector('.confirmation-dialog').remove();
        if (confirmed) {
            // Drugie potwierdzenie
            const secondDialog = document.createElement('div');
            secondDialog.className = 'confirmation-dialog';
            secondDialog.innerHTML = `
                <div class="confirmation-content">
                    <h3>Na pewno na pewno?</h3>
                    <p>To ostatnia szansa na anulowanie. Wszystkie dane zostaną utracone.</p>
                    <div class="confirmation-buttons">
                        <button onclick="finalReset(true)" style="background-color: #dc3545;">TAK, USUŃ WSZYSTKO</button>
                        <button onclick="finalReset(false)">NIE, ANULUJ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(secondDialog);
        }
    }

    // Ostateczne wykonanie resetu
    function finalReset(confirmed) {
        document.querySelector('.confirmation-dialog').remove();
        if (confirmed) {
            resetAllData();
        }
    }

    // Inicjalizacja - ładowanie danych przy starcie
    window.onload = function() {
        loadData();
    };
	
	

async function addItemFromAllegro() {
    const urlInput = document.getElementById('allegro-url');
    const url = urlInput.value.trim();
    const previewDiv = document.getElementById('allegro-preview');
    const titleElement = document.getElementById('allegro-title');
    const quantityElement = document.getElementById('allegro-quantity');
    
    // Sprawdzenie czy elementy istnieją
    if (!previewDiv || !titleElement || !quantityElement) {
        console.error('Brak wymaganych elementów w DOM!');
        alert('Wystąpił błąd systemu. Odśwież stronę.');
        return;
    }

    if (!url) {
        alert('Wklej link z Allegro!');
        urlInput.focus();
        return;
    }

    // Walidacja URL Allegro
    if (!url.includes('allegro.pl/')) {
        alert('To nie jest poprawny link Allegro!');
        urlInput.focus();
        return;
    }

    previewDiv.innerHTML = '<p>Pobieranie danych...</p>';
    previewDiv.style.display = 'block';

    try {
        // Pobieranie danych z Allegro (symulacja - w rzeczywistości potrzebne byłoby API)
        const itemData = await getAllegroData(url);
        
        // Wyświetlenie podglądu
        titleElement.textContent = itemData.title || 'Brak nazwy';
        quantityElement.textContent = itemData.quantity || '1';
        
        // Wybór regału dla przedmiotu
        selectShelfForAllegroItem(itemData.title, itemData.quantity, url);
        
    } catch (error) {
        console.error('Błąd:', error);
        previewDiv.innerHTML = `
            <p style="color:red;">Błąd pobierania danych: ${error.message}</p>
            <button onclick="addItemManually('${url}')" class="shelf-button">Dodaj ręcznie</button>
        `;
    }
}

// Funkcja symulująca pobieranie danych z Allegro
async function getAllegroData(url) {
    // W rzeczywistej implementacji tutaj byłoby połączenie z API Allegro
    // To jest symulacja - w praktyce potrzebowałbyś:
    // 1. Klucza API Allegro
    // 2. Endpointu do pobierania ofert
    // 3. Autoryzacji
    
    return new Promise((resolve, reject) => {
        // Symulacja opóźnienia sieci
        setTimeout(() => {
            try {
                // Próbujemy wyciągnąć nazwę z URL
                let title = url.split('/oferta/')[1];
                if (title) {
                    title = title.split('-').slice(0, -1).join(' ')
                                .replace(/-/g, ' ')
                                .replace(/\d+$/, '');
                } else {
                    title = 'Produkt z Allegro';
                }
                
                // Symulowane dane
                resolve({
                    title: title.charAt(0).toUpperCase() + title.slice(1),
                    quantity: 1, // Domyślna ilość
                    url: url
                });
            } catch (e) {
                reject(new Error('Nie można przetworzyć linku Allegro'));
            }
        }, 1000); // Symulowane opóźnienie
    });
}

// Funkcja wyboru regału dla przedmiotu z Allegro
function selectShelfForAllegroItem(itemName, quantity, url) {
    if (shelves.length === 0) {
        if (confirm('Nie masz jeszcze żadnych regałów. Czy chcesz dodać nowy regał?')) {
            document.getElementById('shelf-name').focus();
            alert('Najpierw dodaj regał, a następnie ponów próbę dodania przedmiotu.');
        }
        return;
    }

    // Wyświetlenie listy regałów do wyboru
    const shelfList = shelves.map(shelf => 
        `${shelf.name} (${shelf.levels} pięter)`
    ).join('\n');

    const shelfChoice = prompt(
        `Wybierz regał dla przedmiotu "${itemName}" (1-${shelves.length}):\n\n` +
        shelves.map((shelf, index) => 
            `${index + 1}. ${shelf.name} (${shelf.levels} pięter)`
        ).join('\n')
    );

    if (!shelfChoice) return;

    const shelfIndex = parseInt(shelfChoice) - 1;
    if (isNaN(shelfIndex) || shelfIndex < 0 || shelfIndex >= shelves.length) {
        alert('Nieprawidłowy wybór regału!');
        return;
    }

    const selectedShelf = shelves[shelfIndex];
    addItem(selectedShelf, itemName, quantity, url, true);
}

// Funkcja do ręcznego dodawania przedmiotu z Allegro
function addItemManually(url) {
    const defaultName = url.split('/oferta/')[1]?.replace(/-/g, ' ').replace(/\d+$/, '') || 'Produkt z Allegro';
    const name = prompt('Podaj nazwę produktu:', defaultName);
    if (!name) return;
    
    const quantity = prompt('Podaj ilość:', '1');
    if (!quantity || isNaN(quantity)) {
        alert('Podaj poprawną ilość!');
        return;
    }
    
    selectShelfForAllegroItem(name, parseInt(quantity), url);
}

// Funkcja rozpoczynająca cykliczną aktualizację stanu przedmiotu z Allegro
function startAllegroItemUpdate(shelfId, itemName, allegroUrl) {
    // Najpierw zatrzymujemy istniejący interwał, jeśli jest
    stopAllegroItemUpdate(shelfId, itemName);

    // Klucz do identyfikacji interwału
    const intervalKey = `${shelfId}-${itemName}`;

    // Uruchamiamy natychmiastową aktualizację
    updateAllegroItem(shelfId, itemName, allegroUrl);

    // Ustawiamy cykliczną aktualizację co 30 minut (1800000 ms)
    updateIntervals[intervalKey] = setInterval(() => {
        updateAllegroItem(shelfId, itemName, allegroUrl);
    }, 1800000); // 30 minut
}

// Funkcja aktualizująca stan przedmiotu z Allegro
async function updateAllegroItem(shelfId, itemName, allegroUrl) {
    try {
        const shelf = shelves.find(s => s.id === shelfId);
        if (!shelf) {
            console.error('Regał nie istnieje:', shelfId);
            return;
        }

        // Pobieramy aktualne dane z Allegro
        const itemData = await getAllegroData(allegroUrl);
        
        // Szukamy przedmiotu we wszystkich piętrach regału
        for (const floor in shelf.items) {
            if (shelf.items[floor][itemName]) {
                // Aktualizujemy ilość
                if (typeof shelf.items[floor][itemName] === 'object') {
                    shelf.items[floor][itemName].quantity = itemData.quantity;
                } else {
                    // Jeśli przedmiot był zapisany jako liczba, konwertujemy na obiekt
                    shelf.items[floor][itemName] = {
                        quantity: itemData.quantity,
                        url: allegroUrl
                    };
                }
                
                // Znaleźliśmy i zaktualizowaliśmy - można przerwać pętlę
                break;
            }
        }

        // Aktualizujemy UI i zapisujemy dane
        updateItemsList();
        saveData();
        
        console.log(`Zaktualizowano przedmiot ${itemName} w regale ${shelf.name}`);
    } catch (error) {
        console.error(`Błąd podczas aktualizacji przedmiotu ${itemName}:`, error);
    }
}

// Funkcja zatrzymująca aktualizację przedmiotu
function stopAllegroItemUpdate(shelfId, itemName) {
    const intervalKey = `${shelfId}-${itemName}`;
    if (updateIntervals[intervalKey]) {
        clearInterval(updateIntervals[intervalKey]);
        delete updateIntervals[intervalKey];
    }
}

// Funkcja przywracająca interwały aktualizacji po załadowaniu strony
function restoreAllegroIntervals() {
    // Najpierw czyścimy wszystkie istniejące interwały
    for (const key in updateIntervals) {
        clearInterval(updateIntervals[key]);
        delete updateIntervals[key];
    }

    // Szukamy przedmiotów z Allegro i uruchamiamy interwały
    shelves.forEach(shelf => {
        for (const floor in shelf.items) {
            for (const itemName in shelf.items[floor]) {
                const itemData = shelf.items[floor][itemName];
                if (typeof itemData === 'object' && itemData.url) {
                    startAllegroItemUpdate(shelf.id, itemName, itemData.url);
                }
            }
        }
    });
}

</script>
</body>
</html>